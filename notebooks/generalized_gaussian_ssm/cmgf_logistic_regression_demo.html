
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Online Logistic Regression using conditional moments Gaussian filter &#8212; dynamax documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Online learning of an MLP Classifier using conditional moments Gaussian filter" href="cmgf_mlp_classification_demo.html" />
    <link rel="prev" title="Online learning for an MLP using extended Kalman filtering" href="../nonlinear_gaussian_ssm/ekf_mlp.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.gif" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  HMMs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../hmm/casino_hmm_inference.html">
   Casino HMM: Inference (state estimation)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hmm/casino_hmm_learning.html">
   Casino HMM: learning (parameter estimation)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hmm/gaussian_hmm.html">
   Gaussian HMM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../hmm/autoregressive_hmm.html">
   Autoregressive (AR) HMM Demo
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Linear Gaussian SSMs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/kf_tracking.html">
   Tracking an object using the Kalman filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/kf_linreg.html">
   Online linear regression using Kalman filtering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_parallel_inference.html">
   Parallel filtering and smoothing in an LG-SSM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_learning.html">
   MAP parameter estimation for an LG-SSM using EM and SGD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../linear_gaussian_ssm/lgssm_hmc.html">
   Bayesian parameter estimation for an LG-SSM using HMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Nonlinear Gaussian SSMs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_spiral.html">
   Tracking a spiraling object using the extended / unscented Kalman filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_pendulum.html">
   Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_mlp.html">
   Online learning for an MLP using extended Kalman filtering
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Generalized Gaussian SSMs
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Online Logistic Regression using conditional moments Gaussian filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cmgf_mlp_classification_demo.html">
   Online learning of an MLP Classifier using conditional moments Gaussian filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cmgf_poisson_demo.html">
   Fitting an LDS with Poisson Likelihood using conditional moments Gaussian filter
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../api.html">
   API
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/probml/dynamax/main?urlpath=tree/docs/notebooks/generalized_gaussian_ssm/cmgf_logistic_regression_demo.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/probml/dynamax/blob/main/docs/notebooks/generalized_gaussian_ssm/cmgf_logistic_regression_demo.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/notebooks/generalized_gaussian_ssm/cmgf_logistic_regression_demo.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-and-plotting">
   Simulation and Plotting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#laplace-estimate">
   Laplace Estimate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dynamical-model">
   Dynamical model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#online-inference">
   Online inference
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ekf">
     EKF
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ukf">
     UKF
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ghkf">
     GHKF
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Online Logistic Regression using conditional moments Gaussian filter</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulation-and-plotting">
   Simulation and Plotting
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#laplace-estimate">
   Laplace Estimate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dynamical-model">
   Dynamical model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#online-inference">
   Online inference
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ekf">
     EKF
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ukf">
     UKF
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ghkf">
     GHKF
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="online-logistic-regression-using-conditional-moments-gaussian-filter">
<h1>Online Logistic Regression using conditional moments Gaussian filter<a class="headerlink" href="#online-logistic-regression-using-conditional-moments-gaussian-filter" title="Permalink to this headline">#</a></h1>
<p>Online training of a logistic regression model using conditional moments Gaussian filter (CMGF).</p>
<p>We perform sequential (recursive) Bayesian inference for the parameters of a binary logistic regression model.
To do this, we treat the parameters of the model as the unknown hidden states.
We assume that these are approximately constant over time (we add a small amount of Gaussian drift,
for numerical stability.)
The graphical model is shown below.</p>
<p><img alt="RLS" src="https://github.com/probml/dynamax/blob/main/docs/figures/rlsDgm.png?raw=true" /></p>
<p>The model has the following form</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{align*}
\theta_t &amp;=  \theta_{t-1} + q_t, \; q_t \sim N(0, 0.01 I)  \\
y_t &amp;\sim Ber(\sigma(\theta_t^T x_t))
\end{align*}\]</div>
<p>This is a generalized Gaussian SSM, where the observation model is non-Gaussian.</p>
<p>To perform approximate inferece, using the  conditional moments Gaussian filter (CMGF).
We approximate the relevant integrals using 3 different methods: linearization (extended Kalman filter),
sigma point approximation (unscented kalman filter), and Gauss hermite integration (order 5).
We compare results with the offline (batch) Laplace approximation, and see that GHKF converges fastest to the batch solution,
but is also slower.
For more details, see sec 8.7.7 of <a class="reference external" href="https://probml.github.io/pml-book/book2.html">Probabilistic Machine Learning: Advanced Topics</a>.</p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dynamax</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;installing dynamax&#39;</span><span class="p">)</span>
    <span class="o">%</span><span class="k">pip</span> install -qq git+https://github.com/probml/dynamax.git
    <span class="kn">import</span> <span class="nn">dynamax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dynamax.generalized_gaussian_ssm.generalized_gaussian_ssm</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dynamax.generalized_gaussian_ssm.conditional_moments_gaussian_filter</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:jax._src.lib.xla_bridge:No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.random</span> <span class="k">as</span> <span class="nn">jr</span>
<span class="kn">from</span> <span class="nn">jax.scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="simulation-and-plotting">
<h2>Simulation and Plotting<a class="headerlink" href="#simulation-and-plotting" title="Permalink to this headline">#</a></h2>
<p>We generate a reasonable 2d binary classification data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_dataset</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">key0</span><span class="p">,</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Generate standardized noisy inputs that correspond to output &#39;0&#39;</span>
    <span class="n">num_zero_points</span> <span class="o">=</span> <span class="n">num_points</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">zero_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">]]</span> <span class="o">*</span> <span class="n">num_zero_points</span><span class="p">)</span>
    <span class="n">zero_input</span> <span class="o">+=</span> <span class="n">jr</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key0</span><span class="p">,</span> <span class="p">(</span><span class="n">num_zero_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Generate standardized noisy inputs that correspond to output &#39;1&#39;</span>
    <span class="n">num_one_points</span> <span class="o">=</span> <span class="n">num_points</span> <span class="o">-</span> <span class="n">num_zero_points</span>
    <span class="n">one_input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]</span> <span class="o">*</span> <span class="n">num_one_points</span><span class="p">)</span>
    <span class="n">one_input</span> <span class="o">+=</span> <span class="n">jr</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="p">(</span><span class="n">num_one_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Stack the inputs and add bias term</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">zero_input</span><span class="p">,</span> <span class="n">one_input</span><span class="p">])</span>
    <span class="n">input_with_bias</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="nb">input</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Generate binary output</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_zero_points</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_one_points</span><span class="p">))])</span>

    <span class="c1"># Shuffle</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_points</span><span class="p">))</span>
        <span class="nb">input</span><span class="p">,</span> <span class="n">input_with_bias</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">input_with_bias</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="nb">input</span><span class="p">,</span> <span class="n">input_with_bias</span><span class="p">,</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate data</span>
<span class="nb">input</span><span class="p">,</span> <span class="n">input_with_bias</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">generate_dataset</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.9.15/x64/lib/python3.9/site-packages/jax/_src/random.py:399: FutureWarning: jax.random.shuffle is deprecated and will be removed in a future release. Use jax.random.permutation with independent=True.
  warnings.warn(msg, FutureWarning)
</pre></div>
</div>
</div>
</div>
<p>Next, we define a function that visualizes the 2d posterior predictive distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">Xspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Zspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Xspace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Zspace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="o">*</span><span class="n">Xspace</span><span class="p">,</span> <span class="n">Zspace</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_boundary</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">Xspace</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xspace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">Xspace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Letâ€™s look at our binary data in 2d.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Binary classification data&quot;</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="n">y</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">output</span><span class="p">]</span>
<span class="n">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b95050c533bc5b0e456c03004c96db3b1a68565ed9757887c1637d7ffef813e5.png" src="../../_images/b95050c533bc5b0e456c03004c96db3b1a68565ed9757887c1637d7ffef813e5.png" />
</div>
</div>
<p>Let us define a grid on which we compute the predictive distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define grid limits</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span>
<span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>

<span class="c1"># Define grid</span>
<span class="n">step</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">input_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="n">step</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="n">step</span><span class="p">]</span>
<span class="n">_</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">input_grid</span><span class="o">.</span><span class="n">shape</span>
<span class="n">input_with_bias_grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)),</span> <span class="n">input_grid</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we define a function to that returns the posterior predictive probability for each point in grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">posterior_predictive_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="p">(</span><span class="n">n_samples</span><span class="p">,))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mij,sm-&gt;sij&quot;</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">samples</span><span class="p">))</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we define a function that plots the convergence of filtered estimates to the batch MAP estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_cmgf_post_laplace</span><span class="p">(</span>
    <span class="n">mean_hist</span><span class="p">,</span> <span class="n">cov_hist</span><span class="p">,</span> <span class="n">w_map</span><span class="p">,</span> <span class="n">lcolors</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">,</span> <span class="n">legend_font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">bb1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">bb2</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">bb3</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">mean_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">tau_hist</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cov_hist</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_hist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tau_hist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w_map</span><span class="p">,</span> <span class="n">lcolors</span><span class="p">)</span>
    <span class="n">n_datapoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_hist</span><span class="p">)</span>
    <span class="n">timesteps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_datapoints</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">wk</span><span class="p">,</span> <span class="n">Pk</span><span class="p">,</span> <span class="n">wk_fix</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">elements</span><span class="p">)):</span>
        <span class="n">fig_weight_k</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">wk</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Pk</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$w_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">$ online (</span><span class="si">{</span><span class="n">filter_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">wk_fix</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$w_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">$ batch (Laplace)&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_datapoints</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ordered sample number&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;weight value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bb1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">legend_font_size</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bb2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">legend_font_size</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bb3</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">legend_font_size</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="laplace-estimate">
<h2>Laplace Estimate<a class="headerlink" href="#laplace-estimate" title="Permalink to this headline">#</a></h2>
<p>We compute a Laplace approximation to the posterior, which we can compare CMGF to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_posterior</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prior_var</span><span class="p">):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">log_prior</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">prior_var</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prediction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_prior</span> <span class="o">+</span> <span class="n">log_likelihood</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">laplace_inference</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prior_var</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Initial random guess</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">input_dim</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">input_dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">prior_var</span><span class="p">)</span>
    
    <span class="c1"># Energy function to minimize</span>
    <span class="n">E</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">log_posterior</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">prior_var</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

    <span class="c1"># Minimize energy function</span>
    <span class="n">w_laplace</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
    <span class="n">cov_laplace</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">E</span><span class="p">)(</span><span class="n">w_laplace</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w_laplace</span><span class="p">,</span> <span class="n">cov_laplace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute Laplace posterior</span>
<span class="n">prior_var</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">w_laplace</span><span class="p">,</span> <span class="n">cov_laplace</span> <span class="o">=</span> <span class="n">laplace_inference</span><span class="p">(</span><span class="n">input_with_bias</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">prior_var</span><span class="o">=</span><span class="n">prior_var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig_adf</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">plot_boundary</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">input_grid</span><span class="p">,</span> <span class="n">w_laplace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7ff8e3638b5a82edac8f5fcd31d61b40176267553cecc2a5e56616c0c82c6968.png" src="../../_images/7ff8e3638b5a82edac8f5fcd31d61b40176267553cecc2a5e56616c0c82c6968.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig_adf</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># Plot Laplace posterior predictive distribution</span>
<span class="n">Z_laplace</span> <span class="o">=</span> <span class="n">posterior_predictive_grid</span><span class="p">(</span><span class="n">input_with_bias_grid</span><span class="p">,</span> <span class="n">w_laplace</span><span class="p">,</span> <span class="n">cov_laplace</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Laplace Predictive Distribution&quot;</span>
<span class="n">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">input_grid</span><span class="p">,</span> <span class="n">Z_laplace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a7c8e6d89c83660d06d6936b3ee4272d7264241afd8292c9aff80199bce2e897.png" src="../../_images/a7c8e6d89c83660d06d6936b3ee4272d7264241afd8292c9aff80199bce2e897.png" />
</div>
</div>
</section>
<section id="dynamical-model">
<h2>Dynamical model<a class="headerlink" href="#dynamical-model" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_with_bias</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">state_dim</span> <span class="o">=</span> <span class="n">input_dim</span> <span class="c1"># linear model</span>
<span class="n">sigmoid_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Initial parameters for all CMGF methods</span>
<span class="n">initial_mean</span><span class="p">,</span> <span class="n">initial_covariance</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">state_dim</span><span class="p">),</span> <span class="n">prior_var</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">state_dim</span><span class="p">)</span>
<span class="n">dynamics_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">w</span>
<span class="n">dynamics_covariance</span> <span class="o">=</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">state_dim</span><span class="p">)</span>
<span class="n">emission_mean_function</span> <span class="o">=</span> <span class="n">sigmoid_fn</span>
<span class="n">emission_cov_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">sigmoid_fn</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sigmoid_fn</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmgf_params</span> <span class="o">=</span> <span class="n">ParamsGGSSM</span><span class="p">(</span>
    <span class="n">initial_mean</span> <span class="o">=</span> <span class="n">initial_mean</span><span class="p">,</span>
    <span class="n">initial_covariance</span> <span class="o">=</span> <span class="n">initial_covariance</span><span class="p">,</span>
    <span class="n">dynamics_function</span> <span class="o">=</span> <span class="n">dynamics_function</span><span class="p">,</span>
    <span class="n">dynamics_covariance</span> <span class="o">=</span> <span class="n">dynamics_covariance</span><span class="p">,</span>
    <span class="n">emission_mean_function</span> <span class="o">=</span> <span class="n">emission_mean_function</span><span class="p">,</span>
    <span class="n">emission_cov_function</span> <span class="o">=</span> <span class="n">emission_cov_function</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="online-inference">
<h2>Online inference<a class="headerlink" href="#online-inference" title="Permalink to this headline">#</a></h2>
<section id="ekf">
<h3>EKF<a class="headerlink" href="#ekf" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run CMGF-EKF and extract final estimates for moments</span>
<span class="n">ekf_post</span> <span class="o">=</span> <span class="n">conditional_moments_gaussian_filter</span><span class="p">(</span><span class="n">cmgf_params</span><span class="p">,</span> <span class="n">EKFIntegrals</span><span class="p">(),</span> <span class="n">output</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_with_bias</span><span class="p">)</span>
<span class="n">ekf_means</span><span class="p">,</span> <span class="n">ekf_covs</span> <span class="o">=</span> <span class="n">ekf_post</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">,</span> <span class="n">ekf_post</span><span class="o">.</span><span class="n">filtered_covariances</span>
<span class="n">w_ekf</span><span class="p">,</span> <span class="n">cov_ekf</span> <span class="o">=</span> <span class="n">ekf_means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ekf_covs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">fig_adf</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># Plot posterior predictive distribution</span>
<span class="n">Z_ekf</span> <span class="o">=</span> <span class="n">posterior_predictive_grid</span><span class="p">(</span><span class="n">input_with_bias_grid</span><span class="p">,</span> <span class="n">w_ekf</span><span class="p">,</span> <span class="n">cov_ekf</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;CMGF-EKF Predictive Distribution&quot;</span>
<span class="n">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">input_grid</span><span class="p">,</span> <span class="n">Z_ekf</span><span class="p">)</span>

<span class="c1"># Plot convergence over time to MAP estimate</span>
<span class="n">lcolors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">]</span>
<span class="n">plot_cmgf_post_laplace</span><span class="p">(</span><span class="n">ekf_means</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">ekf_covs</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">w_laplace</span><span class="p">,</span> <span class="n">lcolors</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;CMGF-EKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6b2d6fd3f131b466c93ea9f8d16b74b5b362c7ab7b54176ac37343b99528d1f7.png" src="../../_images/6b2d6fd3f131b466c93ea9f8d16b74b5b362c7ab7b54176ac37343b99528d1f7.png" />
<img alt="../../_images/406514e6cb6c3d0d9183f43f921ed970972659464d41e4759b9d6ac9f1785403.png" src="../../_images/406514e6cb6c3d0d9183f43f921ed970972659464d41e4759b9d6ac9f1785403.png" />
<img alt="../../_images/9c1f1fbe9a05a220a13a9713ffb9bf0dc68bc5bc892b608c37a0c6c8f4fa3857.png" src="../../_images/9c1f1fbe9a05a220a13a9713ffb9bf0dc68bc5bc892b608c37a0c6c8f4fa3857.png" />
<img alt="../../_images/c74ea7c0148d3b7135d7795b62d99059665546451e76ad47dacec5d4552c4103.png" src="../../_images/c74ea7c0148d3b7135d7795b62d99059665546451e76ad47dacec5d4552c4103.png" />
</div>
</div>
</section>
<section id="ukf">
<h3>UKF<a class="headerlink" href="#ukf" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run CMGF-UKF and extract final estimates for moments</span>
<span class="n">ukf_post</span> <span class="o">=</span> <span class="n">conditional_moments_gaussian_filter</span><span class="p">(</span><span class="n">cmgf_params</span><span class="p">,</span> <span class="n">UKFIntegrals</span><span class="p">(),</span> <span class="n">output</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_with_bias</span><span class="p">)</span>
<span class="n">ukf_means</span><span class="p">,</span> <span class="n">ukf_covs</span> <span class="o">=</span> <span class="n">ukf_post</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">,</span> <span class="n">ukf_post</span><span class="o">.</span><span class="n">filtered_covariances</span>
<span class="n">w_ukf</span><span class="p">,</span> <span class="n">cov_ukf</span> <span class="o">=</span> <span class="n">ukf_means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ukf_covs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">fig_adf</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># Plot posterior predictive distribution</span>
<span class="n">Z_ukf</span> <span class="o">=</span> <span class="n">posterior_predictive_grid</span><span class="p">(</span><span class="n">input_with_bias_grid</span><span class="p">,</span> <span class="n">w_ukf</span><span class="p">,</span> <span class="n">cov_ukf</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;CMGF-UKF Predictive Distribution&quot;</span>
<span class="n">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">input_grid</span><span class="p">,</span> <span class="n">Z_ukf</span><span class="p">)</span>

<span class="n">plot_cmgf_post_laplace</span><span class="p">(</span><span class="n">ukf_means</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">ukf_covs</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">w_laplace</span><span class="p">,</span> <span class="n">lcolors</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;CMGF-UKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/215b4acd821edecd28b1e351d75e61fc96b9aff3707495bb5513a52a4bdb9d7f.png" src="../../_images/215b4acd821edecd28b1e351d75e61fc96b9aff3707495bb5513a52a4bdb9d7f.png" />
<img alt="../../_images/d75a1444e56c20a546641dd0b73c14b70809a190fbdc12bba71908632ab48911.png" src="../../_images/d75a1444e56c20a546641dd0b73c14b70809a190fbdc12bba71908632ab48911.png" />
<img alt="../../_images/62fbaf338117ddf0753876d3445a8af41b2f221b83947ec2662d846f5fcb6107.png" src="../../_images/62fbaf338117ddf0753876d3445a8af41b2f221b83947ec2662d846f5fcb6107.png" />
<img alt="../../_images/2a0cd4df6ac170ddb60143cb8ebeb265f83b1f5f84cd50d26033e7a4785e2f21.png" src="../../_images/2a0cd4df6ac170ddb60143cb8ebeb265f83b1f5f84cd50d26033e7a4785e2f21.png" />
</div>
</div>
</section>
<section id="ghkf">
<h3>GHKF<a class="headerlink" href="#ghkf" title="Permalink to this headline">#</a></h3>
<p>Gauss Hermite Kalman Filter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run CMGF-GHKF and extract final estimates for moments</span>
<span class="n">ghkf_post</span> <span class="o">=</span> <span class="n">conditional_moments_gaussian_filter</span><span class="p">(</span><span class="n">cmgf_params</span><span class="p">,</span> <span class="n">GHKFIntegrals</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">output</span><span class="p">,</span> <span class="n">inputs</span> <span class="o">=</span> <span class="n">input_with_bias</span><span class="p">)</span>
<span class="n">ghkf_means</span><span class="p">,</span> <span class="n">ghkf_covs</span> <span class="o">=</span> <span class="n">ghkf_post</span><span class="o">.</span><span class="n">filtered_means</span><span class="p">,</span> <span class="n">ghkf_post</span><span class="o">.</span><span class="n">filtered_covariances</span>
<span class="n">w_ghkf</span><span class="p">,</span> <span class="n">cov_ghkf</span> <span class="o">=</span> <span class="n">ghkf_means</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ghkf_covs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">fig_adf</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># Plot posterior predictive distribution</span>
<span class="n">Z_ghkf</span> <span class="o">=</span> <span class="n">posterior_predictive_grid</span><span class="p">(</span><span class="n">input_with_bias_grid</span><span class="p">,</span> <span class="n">w_ghkf</span><span class="p">,</span> <span class="n">cov_ghkf</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;CMGF-GHKF Predictive Distribution&quot;</span>
<span class="n">plot_posterior_predictive</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">input_grid</span><span class="p">,</span> <span class="n">Z_ghkf</span><span class="p">)</span>

<span class="n">plot_cmgf_post_laplace</span><span class="p">(</span><span class="n">ghkf_means</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">ghkf_covs</span><span class="p">[::</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span><span class="p">)],</span> <span class="n">w_laplace</span><span class="p">,</span> <span class="n">lcolors</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;CMGF-GHKF&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3e441ea4c68f5a398e20e5388652f5c20548bdb6c70c3489f47751cb74616b11.png" src="../../_images/3e441ea4c68f5a398e20e5388652f5c20548bdb6c70c3489f47751cb74616b11.png" />
<img alt="../../_images/47d5dfa829d18b088cfc2ace944fe3f7cecc8eeab32677e5435061ed5130a224.png" src="../../_images/47d5dfa829d18b088cfc2ace944fe3f7cecc8eeab32677e5435061ed5130a224.png" />
<img alt="../../_images/431901bda0f14f6b75436ff8134697ef1726fccc2acabfe988c60804b009b1c4.png" src="../../_images/431901bda0f14f6b75436ff8134697ef1726fccc2acabfe988c60804b009b1c4.png" />
<img alt="../../_images/1383fa2e613fc8f5b6c297c96f4a4ed2c2e48953f9d306c5b19c1e6f9b3df1cc.png" src="../../_images/1383fa2e613fc8f5b6c297c96f4a4ed2c2e48953f9d306c5b19c1e6f9b3df1cc.png" />
</div>
</div>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../nonlinear_gaussian_ssm/ekf_mlp.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Online learning for an MLP using extended Kalman filtering</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="cmgf_mlp_classification_demo.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Online learning of an MLP Classifier using conditional moments Gaussian filter</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy<br/>
  
      &copy; Copyright 2022, Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>