
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Gaussian HMM: Cross-validation and Model Selection</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/hmm/gaussian_hmm';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Autoregressive (AR) HMM Demo" href="autoregressive_hmm.html" />
    <link rel="prev" title="Casino HMM: Learning (parameter estimation)" href="casino_hmm_learning.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.gif" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../_static/logo.gif" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">HMMs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="casino_hmm_inference.html">Casino HMM: Inference (state estimation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="casino_hmm_learning.html">Casino HMM: Learning (parameter estimation)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Gaussian HMM: Cross-validation and Model Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoregressive_hmm.html">Autoregressive (AR) HMM Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Linear Gaussian SSMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/kf_tracking.html">Tracking an object using the Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/kf_linreg.html">Online linear regression using Kalman filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_parallel_inference.html">Parallel filtering and smoothing in an LG-SSM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_learning.html">MAP parameter estimation for an LG-SSM using EM and SGD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear_gaussian_ssm/lgssm_hmc.html">Bayesian parameter estimation for an LG-SSM using HMC</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Nonlinear Gaussian SSMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_spiral.html">Tracking a spiraling object using the extended / unscented Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_ukf_pendulum.html">Tracking a 1d pendulum using Extended / Unscented Kalman filter/ smoother</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nonlinear_gaussian_ssm/ekf_mlp.html">Online learning for an MLP using extended Kalman filtering</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Generalized Gaussian SSMs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_logistic_regression_demo.html">Online Logistic Regression using conditional moments Gaussian filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_mlp_classification_demo.html">Online learning of an MLP Classifier using conditional moments Gaussian filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../generalized_gaussian_ssm/cmgf_poisson_demo.html">Fitting an LDS with Poisson Likelihood using conditional moments Gaussian filter</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../types.html">Terminology for types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">State Space Model (Base class)</a></li>





</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/probml/dynamax/main?urlpath=tree/docs/notebooks/hmm/gaussian_hmm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/probml/dynamax/blob/main/docs/notebooks/hmm/gaussian_hmm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/probml/dynamax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Gaussian HMM: Cross-validation and Model Selection</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-plotting">Helper functions for plotting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-sample-data">Generate sample data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-a-helper-function-to-perform-leave-one-out-cross-validation">Write a helper function to perform leave-one-out cross-validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-individual-and-average-validation-log-likelihoods-as-a-function-of-number-of-states">Plot the individual and average validation log likelihoods as a function of number of states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states">Now fit a model to all the training data using the chosen number of states</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-fitted-model">Visualize the fitted model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-gaussian-hmms-with-different-constraints-on-the-covariance">Comparing Gaussian HMMs with different constraints on the covariance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="gaussian-hmm-cross-validation-and-model-selection">
<h1>Gaussian HMM: Cross-validation and Model Selection<a class="headerlink" href="#gaussian-hmm-cross-validation-and-model-selection" title="Link to this heading">#</a></h1>
<p>A Gaussian HMM has emissions of the form,</p>
<div class="amsmath math notranslate nohighlight" id="equation-4fda812e-43f7-440d-be10-dcf4873266a3">
<span class="eqno">(1)<a class="headerlink" href="#equation-4fda812e-43f7-440d-be10-dcf4873266a3" title="Permalink to this equation">#</a></span>\[\begin{align}
p(y_t \mid z_t, \theta) &amp;= \mathcal{N}(y_t \mid \mu_{z_t}, \Sigma_{z_t})
\end{align}\]</div>
<p>where the emission parameters <span class="math notranslate nohighlight">\(\theta = \{(\mu_k, \Sigma_k)\}_{k=1}^K\)</span> include the means and covariances for each of the <span class="math notranslate nohighlight">\(K\)</span> discrete states.</p>
<p>Dynamax implements a variety of Gaussian HMMs with different constraints on the parameters (e.g. diagonal, spherical, and tied covariances).
It also includes prior distributions on the parameters. For example, it uses a conjugate <a class="reference external" href="https://en.wikipedia.org/wiki/Normal-inverse-Wishart_distribution">normal-inverse Wishart (NIW)</a> prior for the standard case.</p>
<p>This notebook shows how to:</p>
<ol class="arabic simple">
<li><p>Fit such models using expectation-maximization (EM)</p></li>
<li><p>Use cross-validation to choose the number of discrete states</p></li>
<li><p>Use the log probability of held-out data to choose among different models</p></li>
</ol>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dynamax</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;installing dynamax&#39;</span><span class="p">)</span>
    <span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">dynamax</span><span class="p">[</span><span class="n">notebooks</span><span class="p">]</span>
    <span class="kn">import</span> <span class="nn">dynamax</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.random</span> <span class="k">as</span> <span class="nn">jr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vmap</span>

<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">GaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">DiagonalGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">SphericalGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">SharedCovarianceGaussianHMM</span>
<span class="kn">from</span> <span class="nn">dynamax.utils.plotting</span> <span class="kn">import</span> <span class="n">CMAP</span><span class="p">,</span> <span class="n">COLORS</span><span class="p">,</span> <span class="n">white_to_color_cmap</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="helper-functions-for-plotting">
<h2>Helper functions for plotting<a class="headerlink" href="#helper-functions-for-plotting" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper functions for plotting</span>
<span class="k">def</span> <span class="nf">plot_gaussian_hmm</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Emission Distributions&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">XX</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">num_states</span><span class="p">):</span>
        <span class="n">lls</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">emission_distribution</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lls</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XX</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">white_to_color_cmap</span><span class="p">(</span><span class="n">COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[</span><span class="n">states</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">emissions</span><span class="p">[</span><span class="n">states</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mec</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">emissions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$y_1$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$y_2$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">num_timesteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span>
    <span class="n">emission_dim</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">emission_dim</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">emissions</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">states</span><span class="p">]</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">emissions</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Plot the data superimposed on the generating state sequence</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">):</span>    
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span>
                      <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">COLORS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="s2">&quot;-k&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">means</span><span class="p">[:,</span> <span class="n">d</span><span class="p">],</span> <span class="s2">&quot;:k&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$y_{{t,</span><span class="si">{}</span><span class="s2"> }}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Simulated data from an HMM&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="generate-sample-data">
<h2>Generate sample data<a class="headerlink" href="#generate-sample-data" title="Link to this heading">#</a></h2>
<p>As in the preceding notebooks, we start by sampling data from the model. Here, we add a slight wrinkle: we will sample training and test data, where the latter is only used for model selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_train_batches</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_test_batches</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_timesteps</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Make an HMM and sample data and true underlying states</span>
<span class="n">true_num_states</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">emission_dim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">hmm</span> <span class="o">=</span> <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">)</span>

<span class="c1"># Specify parameters of the HMM</span>
<span class="n">initial_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">)</span> <span class="o">/</span> <span class="n">true_num_states</span>
<span class="n">transition_matrix</span> <span class="o">=</span> <span class="mf">0.80</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">)</span> \
    <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> \
    <span class="o">+</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="n">true_num_states</span>
<span class="n">emission_means</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="p">])</span>
<span class="n">emission_covs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">),</span> <span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        
<span class="n">true_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">initial_probs</span><span class="o">=</span><span class="n">initial_probs</span><span class="p">,</span>
                                <span class="n">transition_matrix</span><span class="o">=</span><span class="n">transition_matrix</span><span class="p">,</span>
                                <span class="n">emission_means</span><span class="o">=</span><span class="n">emission_means</span><span class="p">,</span>
                                <span class="n">emission_covariances</span><span class="o">=</span><span class="n">emission_covs</span><span class="p">)</span>

<span class="c1"># Sample train, validation, and test data</span>
<span class="n">train_key</span><span class="p">,</span> <span class="n">val_key</span><span class="p">,</span> <span class="n">test_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="o">=</span><span class="n">num_timesteps</span><span class="p">))</span>
<span class="n">train_true_states</span><span class="p">,</span> <span class="n">train_emissions</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train_key</span><span class="p">,</span> <span class="n">num_train_batches</span><span class="p">))</span>
<span class="n">test_true_states</span><span class="p">,</span>  <span class="n">test_emissions</span>  <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span> <span class="n">num_test_batches</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">22</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="n">emission_means</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">true_num_states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>     <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>     <span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="n">emission_covs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">emission_dim</span><span class="p">),</span> <span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">22</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">initial_probs</span><span class="o">=</span><span class="n">initial_probs</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>                                 <span class="n">transition_matrix</span><span class="o">=</span><span class="n">transition_matrix</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>                                 <span class="n">emission_means</span><span class="o">=</span><span class="n">emission_means</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>                                 <span class="n">emission_covariances</span><span class="o">=</span><span class="n">emission_covs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="c1"># Sample train, validation, and test data</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="n">train_key</span><span class="p">,</span> <span class="n">val_key</span><span class="p">,</span> <span class="n">test_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

<span class="nn">File ~/work/dynamax/dynamax/dynamax/hidden_markov_model/models/gaussian_hmm.py:651,</span> in <span class="ni">GaussianHMM.initialize</span><span class="nt">(self, key, method, initial_probs, transition_matrix, emission_means, emission_covariances, emissions)</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;initial&quot;</span><span class="p">],</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_component</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">initial_probs</span><span class="o">=</span><span class="n">initial_probs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">650</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;transitions&quot;</span><span class="p">],</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;transitions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_component</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">transition_matrix</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">651</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;emissions&quot;</span><span class="p">],</span> <span class="n">props</span><span class="p">[</span><span class="s2">&quot;emissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_component</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">emission_means</span><span class="o">=</span><span class="n">emission_means</span><span class="p">,</span> <span class="n">emission_covariances</span><span class="o">=</span><span class="n">emission_covariances</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">emissions</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">652</span> <span class="k">return</span> <span class="n">ParamsGaussianHMM</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">),</span> <span class="n">ParamsGaussianHMM</span><span class="p">(</span><span class="o">**</span><span class="n">props</span><span class="p">)</span>

<span class="nn">File ~/work/dynamax/dynamax/dynamax/hidden_markov_model/models/gaussian_hmm.py:83,</span> in <span class="ni">GaussianHMMEmissions.initialize</span><span class="nt">(self, key, method, emission_means, emission_covariances, emissions)</span>
<span class="g g-Whitespace">     </span><span class="mi">81</span> <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;prior&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span>     <span class="n">this_key</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">83</span>     <span class="n">prior</span> <span class="o">=</span> <span class="n">NormalInverseWishart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_prior_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_prior_conc</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">84</span>                                  <span class="bp">self</span><span class="o">.</span><span class="n">emission_prior_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_prior_scale</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>     <span class="p">(</span><span class="n">_emission_covs</span><span class="p">,</span> <span class="n">_emission_means</span><span class="p">)</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">this_key</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_states</span><span class="p">,))</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span> <span class="k">else</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/decorator.py:232,</span> in <span class="ni">decorate.&lt;locals&gt;.fun</span><span class="nt">(*args, **kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwsyntax</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">fix</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">232</span> <span class="k">return</span> <span class="n">caller</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">extras</span> <span class="o">+</span> <span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/distributions/distribution.py:342,</span> in <span class="ni">_DistributionMeta.__new__.&lt;locals&gt;.wrapped_init</span><span class="nt">(***failed resolving arguments***)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="c1"># Note: if we ever want to have things set in `self` before `__init__` is</span>
<span class="g g-Whitespace">    </span><span class="mi">340</span> <span class="c1"># called, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">342</span> <span class="n">default_init</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">343</span> <span class="c1"># Note: if we ever want to override things set in `self` by subclass</span>
<span class="g g-Whitespace">    </span><span class="mi">344</span> <span class="c1"># `__init__`, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">345</span> <span class="k">if</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">346</span>   <span class="c1"># We prefer subclasses will set `parameters = dict(locals())` because</span>
<span class="g g-Whitespace">    </span><span class="mi">347</span>   <span class="c1"># this has nearly zero overhead. However, failing to do this, we will</span>
<span class="g g-Whitespace">    </span><span class="mi">348</span>   <span class="c1"># resolve the input arguments dynamically and only when needed.</span>

<span class="nn">File ~/work/dynamax/dynamax/dynamax/utils/distributions.py:133,</span> in <span class="ni">NormalInverseWishart.__init__</span><span class="nt">(self, loc, mean_concentration, df, scale)</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">scale</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span> <span class="nb">super</span><span class="p">(</span><span class="n">NormalInverseWishart</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span>
<span class="ne">--&gt; </span><span class="mi">133</span>     <span class="n">InverseWishart</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="k">lambda</span> <span class="n">Sigma</span><span class="p">:</span> <span class="n">tfd</span><span class="o">.</span><span class="n">MultivariateNormalFullCovariance</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">Sigma</span> <span class="o">/</span> <span class="n">mean_concentration</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span> <span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">mean_concentration</span><span class="o">=</span><span class="n">mean_concentration</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/decorator.py:232,</span> in <span class="ni">decorate.&lt;locals&gt;.fun</span><span class="nt">(*args, **kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwsyntax</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">fix</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">232</span> <span class="k">return</span> <span class="n">caller</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">extras</span> <span class="o">+</span> <span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/distributions/distribution.py:342,</span> in <span class="ni">_DistributionMeta.__new__.&lt;locals&gt;.wrapped_init</span><span class="nt">(***failed resolving arguments***)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="c1"># Note: if we ever want to have things set in `self` before `__init__` is</span>
<span class="g g-Whitespace">    </span><span class="mi">340</span> <span class="c1"># called, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">342</span> <span class="n">default_init</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">343</span> <span class="c1"># Note: if we ever want to override things set in `self` by subclass</span>
<span class="g g-Whitespace">    </span><span class="mi">344</span> <span class="c1"># `__init__`, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">345</span> <span class="k">if</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">346</span>   <span class="c1"># We prefer subclasses will set `parameters = dict(locals())` because</span>
<span class="g g-Whitespace">    </span><span class="mi">347</span>   <span class="c1"># this has nearly zero overhead. However, failing to do this, we will</span>
<span class="g g-Whitespace">    </span><span class="mi">348</span>   <span class="c1"># resolve the input arguments dynamically and only when needed.</span>

<span class="nn">File ~/work/dynamax/dynamax/dynamax/utils/distributions.py:51,</span> in <span class="ni">InverseWishart.__init__</span><span class="nt">(self, df, scale)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="n">cho_scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span> <span class="n">inv_scale_tril</span> <span class="o">=</span> <span class="n">solve_triangular</span><span class="p">(</span><span class="n">cho_scale</span><span class="p">,</span> <span class="n">eye</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">51</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>     <span class="n">tfd</span><span class="o">.</span><span class="n">WishartTriL</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scale_tril</span><span class="o">=</span><span class="n">inv_scale_tril</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="n">tfb</span><span class="o">.</span><span class="n">Chain</span><span class="p">([</span><span class="n">tfb</span><span class="o">.</span><span class="n">CholeskyOuterProduct</span><span class="p">(),</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>                <span class="n">tfb</span><span class="o">.</span><span class="n">CholeskyToInvCholesky</span><span class="p">(),</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>                <span class="n">tfb</span><span class="o">.</span><span class="n">Invert</span><span class="p">(</span><span class="n">tfb</span><span class="o">.</span><span class="n">CholeskyOuterProduct</span><span class="p">())]))</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/decorator.py:232,</span> in <span class="ni">decorate.&lt;locals&gt;.fun</span><span class="nt">(*args, **kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwsyntax</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">fix</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">232</span> <span class="k">return</span> <span class="n">caller</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">extras</span> <span class="o">+</span> <span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/distributions/distribution.py:342,</span> in <span class="ni">_DistributionMeta.__new__.&lt;locals&gt;.wrapped_init</span><span class="nt">(***failed resolving arguments***)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="c1"># Note: if we ever want to have things set in `self` before `__init__` is</span>
<span class="g g-Whitespace">    </span><span class="mi">340</span> <span class="c1"># called, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">--&gt; </span><span class="mi">342</span> <span class="n">default_init</span><span class="p">(</span><span class="n">self_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">343</span> <span class="c1"># Note: if we ever want to override things set in `self` by subclass</span>
<span class="g g-Whitespace">    </span><span class="mi">344</span> <span class="c1"># `__init__`, here is the place to do it.</span>
<span class="g g-Whitespace">    </span><span class="mi">345</span> <span class="k">if</span> <span class="n">self_</span><span class="o">.</span><span class="n">_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">346</span>   <span class="c1"># We prefer subclasses will set `parameters = dict(locals())` because</span>
<span class="g g-Whitespace">    </span><span class="mi">347</span>   <span class="c1"># this has nearly zero overhead. However, failing to do this, we will</span>
<span class="g g-Whitespace">    </span><span class="mi">348</span>   <span class="c1"># resolve the input arguments dynamically and only when needed.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/distributions/transformed_distribution.py:244,</span> in <span class="ni">_TransformedDistribution.__init__</span><span class="nt">(self, distribution, bijector, kwargs_split_fn, validate_args, parameters, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> <span class="c1"># We don&#39;t just want to check isinstance(JointDistribution) because</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span> <span class="c1"># TransformedDistributions with multipart bijectors are effectively</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span> <span class="c1"># joint but don&#39;t inherit from JD. The &#39;duck-type&#39; test is that</span>
<span class="g g-Whitespace">    </span><span class="mi">243</span> <span class="c1"># JDs have a structured dtype.</span>
<span class="ne">--&gt; </span><span class="mi">244</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bijector</span><span class="o">.</span><span class="n">forward_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_joint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">is_nested</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span> <span class="nb">super</span><span class="p">(</span><span class="n">_TransformedDistribution</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>     <span class="n">reparameterization_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distribution</span><span class="o">.</span><span class="n">reparameterization_type</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>     <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span>     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/bijectors/bijector.py:1705,</span> in <span class="ni">Bijector.forward_dtype</span><span class="nt">(self, dtype, name, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1701</span>   <span class="n">input_dtype</span> <span class="o">=</span> <span class="n">nest_util</span><span class="o">.</span><span class="n">broadcast_structure</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1702</span>       <span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1703</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1704</span>   <span class="c1"># Make sure inputs are compatible with statically-known dtype.</span>
<span class="ne">-&gt; </span><span class="mi">1705</span>   <span class="n">input_dtype</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">map_structure_up_to</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1706</span>       <span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1707</span>       <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dtype_util</span><span class="o">.</span><span class="n">convert_to_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1708</span>       <span class="n">nest_util</span><span class="o">.</span><span class="n">coerce_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1709</span>       <span class="n">check_types</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1711</span> <span class="n">output_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_dtype</span><span class="p">(</span><span class="n">input_dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1712</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1713</span>   <span class="c1"># kwargs may alter dtypes themselves, but we currently require</span>
<span class="g g-Whitespace">   </span><span class="mi">1714</span>   <span class="c1"># structure to be statically known.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/python/internal/backend/jax/nest.py:324,</span> in <span class="ni">map_structure_up_to</span><span class="nt">(shallow_structure, func, *structures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span> <span class="k">def</span> <span class="nf">map_structure_up_to</span><span class="p">(</span><span class="n">shallow_structure</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">324</span>   <span class="k">return</span> <span class="n">map_structure_with_tuple_paths_up_to</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>       <span class="n">shallow_structure</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span>       <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span>  <span class="c1"># Discards path.</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span>       <span class="o">*</span><span class="n">structures</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">328</span>       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/python/internal/backend/jax/nest.py:353,</span> in <span class="ni">map_structure_with_tuple_paths_up_to</span><span class="nt">(shallow_structure, func, expand_composites, *structures, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">350</span> <span class="k">for</span> <span class="n">input_tree</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">351</span>   <span class="n">assert_shallow_structure</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>       <span class="n">shallow_structure</span><span class="p">,</span> <span class="n">input_tree</span><span class="p">,</span> <span class="n">check_types</span><span class="o">=</span><span class="n">check_types</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">353</span> <span class="k">return</span> <span class="n">dm_tree</span><span class="o">.</span><span class="n">map_structure_with_path_up_to</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span>     <span class="n">shallow_structure</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tree/__init__.py:778,</span> in <span class="ni">map_structure_with_path_up_to</span><span class="nt">(***failed resolving arguments***)</span>
<span class="g g-Whitespace">    </span><span class="mi">776</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">777</span> <span class="k">for</span> <span class="n">path_and_values</span> <span class="ow">in</span> <span class="n">_multiyield_flat_up_to</span><span class="p">(</span><span class="n">shallow_structure</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">778</span>   <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">path_and_values</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">779</span> <span class="k">return</span> <span class="n">unflatten_as</span><span class="p">(</span><span class="n">shallow_structure</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/python/internal/backend/jax/nest.py:326,</span> in <span class="ni">map_structure_up_to.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(_, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span> <span class="k">def</span> <span class="nf">map_structure_up_to</span><span class="p">(</span><span class="n">shallow_structure</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">324</span>   <span class="k">return</span> <span class="n">map_structure_with_tuple_paths_up_to</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span>       <span class="n">shallow_structure</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">326</span>       <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span>  <span class="c1"># Discards path.</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span>       <span class="o">*</span><span class="n">structures</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">328</span>       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/bijectors/bijector.py:1707,</span> in <span class="ni">Bijector.forward_dtype.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(x)</span>
<span class="g g-Whitespace">   </span><span class="mi">1701</span>   <span class="n">input_dtype</span> <span class="o">=</span> <span class="n">nest_util</span><span class="o">.</span><span class="n">broadcast_structure</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1702</span>       <span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1703</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1704</span>   <span class="c1"># Make sure inputs are compatible with statically-known dtype.</span>
<span class="g g-Whitespace">   </span><span class="mi">1705</span>   <span class="n">input_dtype</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">map_structure_up_to</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1706</span>       <span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">1707</span>       <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dtype_util</span><span class="o">.</span><span class="n">convert_to_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1708</span>       <span class="n">nest_util</span><span class="o">.</span><span class="n">coerce_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_min_event_ndims</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1709</span>       <span class="n">check_types</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1711</span> <span class="n">output_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_dtype</span><span class="p">(</span><span class="n">input_dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1712</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1713</span>   <span class="c1"># kwargs may alter dtypes themselves, but we currently require</span>
<span class="g g-Whitespace">   </span><span class="mi">1714</span>   <span class="c1"># structure to be statically known.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tensorflow_probability/substrates/jax/internal/dtype_util.py:247,</span> in <span class="ni">convert_to_dtype</span><span class="nt">(tensor_or_dtype, dtype, dtype_hint)</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tensor_or_dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span>   <span class="n">dt</span> <span class="o">=</span> <span class="n">base_dtype</span><span class="p">(</span><span class="n">dtype</span> <span class="ow">or</span> <span class="n">dtype_hint</span> <span class="ow">or</span> <span class="n">tensor_or_dtype</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">247</span> <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">issctype</span><span class="p">(</span><span class="n">tensor_or_dtype</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>   <span class="n">dt</span> <span class="o">=</span> <span class="n">base_dtype</span><span class="p">(</span><span class="n">dtype</span> <span class="ow">or</span> <span class="n">dtype_hint</span> <span class="ow">or</span> <span class="n">tensor_or_dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">250</span>   <span class="c1"># If this is a Python object, call `convert_to_tensor` and grab the dtype.</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>   <span class="c1"># Note that this will add ops in graph-mode; we may want to consider</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>   <span class="c1"># other ways to handle this case.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/numpy/__init__.py:397,</span> in <span class="ni">__getattr__</span><span class="nt">(attr)</span>
<span class="g g-Whitespace">    </span><span class="mi">394</span>     <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">__former_attrs__</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">__expired_attributes__</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">397</span>     <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">398</span>         <span class="sa">f</span><span class="s2">&quot;`np.</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">` was removed in the NumPy 2.0 release. &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">399</span>         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">__expired_attributes__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span> <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;chararray&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span>     <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">404</span>         <span class="s2">&quot;`np.chararray` is deprecated and will be removed from &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span>         <span class="s2">&quot;the main namespace in the future. Use an array with a string &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span>         <span class="s2">&quot;or bytes dtype instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">AttributeError</span>: `np.issctype` was removed in the NumPy 2.0 release. Use `issubclass(rep, np.generic)` instead.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot emissions and true_states in the emissions plane</span>
<span class="n">plot_gaussian_hmm</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_true_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;True HMM emission distribution&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/263a661121f40d06c65fcf1ef0a76e8d3b5b40afbec1ef7cb2efdfdcdf0e4161.png" src="../../_images/263a661121f40d06c65fcf1ef0a76e8d3b5b40afbec1ef7cb2efdfdcdf0e4161.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot emissions vs. time with background colored by true state</span>
<span class="n">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">hmm</span><span class="p">,</span> <span class="n">true_params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">train_true_states</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/57051aaa1c7df49cad433ee33fb43f455340ba93bcc287d6ab32cb54fcb16605.png" src="../../_images/57051aaa1c7df49cad433ee33fb43f455340ba93bcc287d6ab32cb54fcb16605.png" />
</div>
</div>
</section>
<section id="write-a-helper-function-to-perform-leave-one-out-cross-validation">
<h2>Write a helper function to perform leave-one-out cross-validation<a class="headerlink" href="#write-a-helper-function-to-perform-leave-one-out-cross-validation" title="Link to this heading">#</a></h2>
<p>This function fits the data into <em>folds</em> where each fold consists of all
but one of the training sequences. It fits the model to each fold in
parallel, and then computes the log likelihood of the held-out sequence for
each fold. The average held-out log likelihood is what we will use for
determining the number of discrete states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cross_validate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Initialize the parameters using K-Means on the full training set</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
    
    <span class="c1"># Split the training data into folds.</span>
    <span class="c1"># Note: this is memory inefficient but it highlights the use of vmap.</span>
    <span class="n">folds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">train_emissions</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">train_emissions</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_train_batches</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_fit_fold</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
        <span class="n">fit_params</span><span class="p">,</span> <span class="n">train_lps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
                                             <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">(</span><span class="n">fit_params</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>

    <span class="n">val_lls</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">_fit_fold</span><span class="p">)(</span><span class="n">folds</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val_lls</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">val_lls</span>
</pre></div>
</div>
</div>
</div>
<p>Now run the cross-validation function on a sequence of models with number of states ranging from 2 to 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a range of Gaussian HMMs</span>
<span class="n">all_num_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">test_hmms</span> <span class="o">=</span> <span class="p">[</span><span class="n">GaussianHMM</span><span class="p">(</span><span class="n">num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span> 
          <span class="k">for</span> <span class="n">num_states</span> <span class="ow">in</span> <span class="n">all_num_states</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">test_hmm</span> <span class="ow">in</span> <span class="n">test_hmms</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fitting model with </span><span class="si">{</span><span class="n">test_hmm</span><span class="o">.</span><span class="n">num_states</span><span class="si">}</span><span class="s2"> states&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cross_validate_model</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
    
<span class="n">avg_val_lls</span><span class="p">,</span> <span class="n">all_val_lls</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fitting model with 2 states
fitting model with 3 states
fitting model with 4 states
fitting model with 5 states
fitting model with 6 states
fitting model with 7 states
fitting model with 8 states
fitting model with 9 states
</pre></div>
</div>
</div>
</div>
<section id="plot-the-individual-and-average-validation-log-likelihoods-as-a-function-of-number-of-states">
<h3>Plot the individual and average validation log likelihoods as a function of number of states<a class="headerlink" href="#plot-the-individual-and-average-validation-log-likelihoods-as-a-function-of-number-of-states" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_num_states</span><span class="p">,</span> <span class="n">avg_val_lls</span><span class="p">,</span> <span class="s1">&#39;-ko&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">per_fold_val_lls</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_num_states</span><span class="p">,</span> <span class="n">all_val_lls</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">per_fold_val_lls</span><span class="p">),</span> <span class="n">per_fold_val_lls</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;num states ($K$)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;avg. validation log prob.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;avg. validation log prob.&#39;)
</pre></div>
</div>
<img alt="../../_images/8e555628b871f5194fea5076cb0bbd6b5d5b93453e450b3e12afcfaa73f2422c.png" src="../../_images/8e555628b871f5194fea5076cb0bbd6b5d5b93453e450b3e12afcfaa73f2422c.png" />
</div>
</div>
<p>Theres no right answer for how to choose the number of states, but reasonable heuristics include:</p>
<ul class="simple">
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> that has the highest average validation log prob</p></li>
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> where the average validation log prob stops increasing by a minimum amount</p></li>
<li><p>picking <span class="math notranslate nohighlight">\(K\)</span> with a hypothesis test for increasing mean</p></li>
</ul>
<p>Here, well just choose the number of states with the highest average.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_num_states</span> <span class="o">=</span> <span class="n">all_num_states</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">avg_val_lls</span><span class="p">))]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;best number of states:&quot;</span><span class="p">,</span> <span class="n">best_num_states</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>best number of states: 5
</pre></div>
</div>
</div>
</div>
</section>
<section id="now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states">
<h3>Now fit a model to all the training data using the chosen number of states<a class="headerlink" href="#now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the parameters using K-Means on the full training set</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_hmm</span> <span class="o">=</span> <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">best_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
<span class="n">params</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 00:02&lt;00:00]
    </div>
    </div></div>
</div>
<p>Plot the log probabilities over the course of training, along with those of the model with the parameters that generated the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate the log probability of the training data under the true parameters</span>
<span class="n">true_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">params</span><span class="p">))(</span><span class="n">train_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">true_lp</span> <span class="o">+=</span> <span class="n">hmm</span><span class="o">.</span><span class="n">log_prior</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># Plot log probs vs num_iterations</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lps</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">),</span> <span class="n">lps</span><span class="p">[</span><span class="n">offset</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">true_lp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;num epochs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;log prob&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fb0e9c77520&gt;
</pre></div>
</div>
<img alt="../../_images/c482e0bda2751c27a8abc67bfd9f28ac7fa6e6605d5e31d8971f42258cb2fb54.png" src="../../_images/c482e0bda2751c27a8abc67bfd9f28ac7fa6e6605d5e31d8971f42258cb2fb54.png" />
</div>
</div>
</section>
</section>
<section id="visualize-the-fitted-model">
<h2>Visualize the fitted model<a class="headerlink" href="#visualize-the-fitted-model" title="Link to this heading">#</a></h2>
<p>Well make the same plots as above, but now using the fitted parameters and the chosen number of states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">most_likely_states</span> <span class="o">=</span> <span class="n">test_hmm</span><span class="o">.</span><span class="n">most_likely_states</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_gaussian_hmm</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">most_likely_states</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fitted Model with </span><span class="si">{</span><span class="n">best_num_states</span><span class="si">}</span><span class="s2"> states&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8da692ad44858c2a0c6eea78c896162aa7eed591203525718e300919a0234562.png" src="../../_images/8da692ad44858c2a0c6eea78c896162aa7eed591203525718e300919a0234562.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_gaussian_hmm_data</span><span class="p">(</span><span class="n">test_hmm</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">most_likely_states</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/85997647c13046499e4f1b8746650e37544bdce468d7d44908b1503db3a65cd3.png" src="../../_images/85997647c13046499e4f1b8746650e37544bdce468d7d44908b1503db3a65cd3.png" />
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note that the marginal log probability is invariant to relabeling of the states. Compare these plots to the ones at the top from the true model. Youll see that the states have been permuted.</p>
</div>
</section>
<section id="comparing-gaussian-hmms-with-different-constraints-on-the-covariance">
<h2>Comparing Gaussian HMMs with different constraints on the covariance<a class="headerlink" href="#comparing-gaussian-hmms-with-different-constraints-on-the-covariance" title="Link to this heading">#</a></h2>
<p>Dynamax implements Gaussian HMMs with different constraints on the covariance matrices:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.DiagonalGaussianHMM"><code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code></a> assumes the covariance matrices are diagonal (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \mathrm{diag}([\sigma_{k,1}^2, \ldots, \sigma_{k,D}^2])\)</span>)</p></li>
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.SphericalGaussianHMM"><code class="docutils literal notranslate"><span class="pre">SphericalGaussianHMM</span></code></a> assumes the covariance matrices are spherical (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \sigma_k^2 I\)</span>)</p></li>
<li><p><a class="reference external" href="https://probml.github.io/dynamax/api.html#dynamax.hidden_markov_model.SharedCovarianceGaussianHMM"><code class="docutils literal notranslate"><span class="pre">SharedCovarianceGaussianHMM</span></code></a> assumes the covariance matrices are the same for all states (i.e. <span class="math notranslate nohighlight">\(\Sigma_k = \Sigma\)</span>)</p></li>
</ul>
<p>In this last section, we will compare these models based on the marginal probability they assign to the test data.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Usually, you would use cross-validation to choose the number of discrete states for each type of model, and then evaluate them on test data. For simplicity, we will assume that we know the true number of states.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Initialize the parameters using K-Means on the full training set</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">emissions</span><span class="o">=</span><span class="n">train_emissions</span><span class="p">)</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_em</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">train_emissions</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">test_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">params</span><span class="p">))(</span><span class="n">test_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">test_lp</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">GaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">DiagonalGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">SphericalGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
    <span class="n">SharedCovarianceGaussianHMM</span><span class="p">(</span><span class="n">true_num_states</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">,</span> <span class="n">transition_matrix_stickiness</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Fit the models and collect the test log probabilities</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_lps</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
<span class="c1"># Compare to the log probability under the true model</span>
<span class="n">true_test_lp</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">hmm</span><span class="o">.</span><span class="n">marginal_log_prob</span><span class="p">,</span> <span class="n">true_params</span><span class="p">))(</span><span class="n">test_emissions</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Marginal log probabilities of test data:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">test_lp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">test_lps</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">:</span><span class="s2"> &gt;30</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">test_lp</span><span class="si">:</span><span class="s2"> .1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;True Model&#39;</span><span class="si">:</span><span class="s2"> &gt;30</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">true_test_lp</span><span class="si">:</span><span class="s2"> .1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Marginal log probabilities of test data:
                   GaussianHMM:  92.7
           DiagonalGaussianHMM:  109.0
          SphericalGaussianHMM:  102.2
   SharedCovarianceGaussianHMM:  103.7
                    True Model:  109.8
</pre></div>
</div>
</div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code> has the highest test log likelihood, and its almost as high as the log probability under the true parameters. The standard <code class="docutils literal notranslate"><span class="pre">GaussianHMM</span></code>, which allows for arbitrary covariance matrices is underperforming on test data, likely because it overfits the training data with its extra flexibility.</p>
<p>Here, the true parameters were in fact spherical and shared across all states, so its perhaps a bit surprising that the more general diagonal covariance model wins out on test data. Keep in mind, however, that there is some amount of randomness in both the sampled data and the initialization of these models, so the particular ordering might change from one random seed to the next. In actual applications, you should compute means and standard errors by running these analyses with multiple random seeds.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>Dynamax provides a family of Gaussian HMMs for multivariate continuous emissions. This notebook showed how to use cross-validation to choose the number of discrete states, and how to compare model families (e.g. <code class="docutils literal notranslate"><span class="pre">GaussianHMM</span></code> vs <code class="docutils literal notranslate"><span class="pre">DiagonalGaussianHMM</span></code>) on test data.</p>
<p>Now that you have seen HMMs with categorical and Gaussian emissions, you can pattern-match to use the other HMMs. See the <a class="reference external" href="https://probml.github.io/dynamax/api.html#high-level-models">documentation</a> for a complete list.</p>
<p>The next notebook highlights one more generalization of the standard HMM to <em>autoregressive</em> emissions, where the emissions depend on preceding emissions as well as the current discrete state.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="casino_hmm_learning.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Casino HMM: Learning (parameter estimation)</p>
      </div>
    </a>
    <a class="right-next"
       href="autoregressive_hmm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Autoregressive (AR) HMM Demo</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions-for-plotting">Helper functions for plotting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-sample-data">Generate sample data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-a-helper-function-to-perform-leave-one-out-cross-validation">Write a helper function to perform leave-one-out cross-validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-individual-and-average-validation-log-likelihoods-as-a-function-of-number-of-states">Plot the individual and average validation log likelihoods as a function of number of states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#now-fit-a-model-to-all-the-training-data-using-the-chosen-number-of-states">Now fit a model to all the training data using the chosen number of states</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-fitted-model">Visualize the fitted model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-gaussian-hmms-with-different-constraints-on-the-covariance">Comparing Gaussian HMMs with different constraints on the covariance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2022, Peter Chang, Giles Harper-Donnelly, Aleyna Kara, Xinglong Li, Scott Linderman, and Kevin Murphy.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>